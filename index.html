<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>메랜파티존 | Maple Party Zone</title>
  <meta name="description" content="메이플랜드 파티모집 - 메랜파티존" />
  <meta name="robots" content="index,follow" />
  <style>
    :root{
      --page-bg:#121212;
      --card-bg:#2a2a2a;
      --muted:#b3b3b3;
      --accent:#5865F2;
      --text:#f5f5f5;
      --border:#3b3b3b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Pretendard','Noto Sans KR',system-ui,sans-serif;
      background:var(--page-bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 22px;background:#1b1b1b;border-bottom:1px solid var(--border);
    }
    .logo{font-weight:800;font-size:1.2rem;color:#fff;cursor:pointer}
    #loginArea{display:flex;align-items:center;gap:8px}
    #loginArea button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:white;cursor:pointer}
    
    /* --- 카드형 맵 선택 --- */
    .worlds{display:flex;gap:16px;overflow-x:auto;padding:18px 22px}
    .world{flex:0 0 180px;height:100px;border-radius:10px;background-size:cover;background-position:center;position:relative;cursor:pointer;transition:transform .2s ease,box-shadow .2s}
    .world:hover{transform:scale(1.04);box-shadow:0 0 10px rgba(88,101,242,.5)}
    .world::after{content:"";position:absolute;inset:0;background:rgba(0,0,0,0.35);border-radius:10px}
    .world .label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;color:white;z-index:2;text-shadow:0 2px 8px rgba(0,0,0,0.8)}
    
    /* --- 게시판 카드 --- */
    .container{max-width:1100px;margin:25px auto;padding:0 20px}
    .card{background:var(--card-bg);padding:20px;border-radius:14px;border:1px solid var(--border);box-shadow:0 3px 8px rgba(0,0,0,0.4)}
    .main-grid{display:block;gap:18px}
    textarea{
      width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);
      background:#1c1c1c;color:var(--text);font-size:14px;line-height:1.5;resize:vertical;min-height:180px;
    }
    .actions{display:flex;gap:8px;align-items:center;margin-top:10px}
    button.primary{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
    .small{font-size:13px;color:var(--muted)}
    .post{margin-bottom:12px;padding:14px;border-radius:10px;background:#1c1c1c;border:1px solid var(--border)}
    .post .meta{margin-top:8px;font-size:13px;color:var(--muted);display:flex;justify-content:space-between;gap:8px;align-items:center}
    a.author{color:var(--accent);text-decoration:none;font-weight:700}
    
    /* --- 검색창 --- */
    .search-bar{
      display:flex;align-items:center;gap:8px;margin-bottom:14px;
    }
    .search-bar input{
      flex:1;
      background:#1c1c1c;
      border:1px solid var(--border);
      border-radius:8px;
      padding:10px;
      color:var(--text);
    }
    .search-bar button{
      background:var(--accent);
      border:none;
      color:#fff;
      border-radius:8px;
      padding:8px 12px;
      cursor:pointer;
    }

    @media(max-width:980px){
      .world{flex:0 0 140px;height:80px}
      .container{padding:0 12px}
    }
  </style>
</head>
<body>
  <header>
    <div class="logo" id="logoBtn">🍁 메랜파티존</div>
    <div id="loginArea"><button id="loginBtn">디스코드 로그인</button></div>
  </header>

  <div class="worlds">
    <div class="world" style="background-image:url('./images/victoria.png')"><div class="label">빅토리아 아일랜드</div></div>
    <div class="world" style="background-image:url('./images/elnath.png')"><div class="label">엘나스 산맥</div></div>
    <div class="world" style="background-image:url('./images/luduslake.png')"><div class="label">루더스 호수</div></div>
    <div class="world" style="background-image:url('./images/minar.png')"><div class="label">미나르 숲</div></div>
    <div class="world" style="background-image:url('./images/aqua.png')"><div class="label">아쿠아 로드</div></div>
    <div class="world" style="background-image:url('./images/nihal.png')"><div class="label">니할 사막</div></div>
  </div>

  <div class="container">
    <div class="card main-grid">
      <h2 style="margin-top:0;">모집 게시판</h2>
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="작성자 또는 내용 검색..." />
        <button id="clearSearch">초기화</button>
      </div>

      <textarea id="postContent" placeholder="모집 내용을 입력하세요 (최대 8줄)"></textarea>
      <div class="actions">
        <button id="submitPost" class="primary">모집 등록</button>
      </div>

      <div id="postList" style="margin-top:16px"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB059CBnkyxlsJZbMfbBK5AJ_s4XKbYGcI",
      authDomain: "maple-partyzone.firebaseapp.com",
      projectId: "maple-partyzone",
      storageBucket: "maple-partyzone.firebasestorage.app",
      messagingSenderId: "853981783847",
      appId: "1:853981783847:web:2305406459583a8f072b02",
      measurementId: "G-CNGYW8FF27"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const postList = document.getElementById("postList");
    const postContent = document.getElementById("postContent");
    const postButton = document.getElementById("submitPost");
    const searchInput = document.getElementById("searchInput");
    const clearSearch = document.getElementById("clearSearch");

    async function loadPosts(filter = "") {
      postList.innerHTML = "";
      const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      let posts = [];
      snapshot.forEach(doc => posts.push(doc.data()));

      if (filter.trim()) {
        const lower = filter.toLowerCase();
        posts = posts.filter(p => 
          (p.content && p.content.toLowerCase().includes(lower)) ||
          (p.author && p.author.toLowerCase().includes(lower))
        );
      }

      if (posts.length === 0) {
        postList.innerHTML = "<div class='small'>검색된 모집글이 없습니다.</div>";
        return;
      }

      posts.forEach(data => {
        const date = data.timestamp?.toDate().toLocaleString("ko-KR") || "방금 전";
        const author = data.author || "익명";
        const authorId = data.discordId || "";
        const dmLink = authorId ? `https://discord.com/users/${authorId}` : "#";
        const li = document.createElement("div");
        li.className = "post";
        li.innerHTML = `
          <div>${(data.content || "").split(/\n/).slice(0,8).map(line => line).join("<br>")}</div>
          <div class="meta">
            <a class="author" href="${dmLink}" target="_blank">${author}</a>
            <div>🕒 ${date}</div>
          </div>
        `;
        postList.appendChild(li);
      });
    }

    postButton.addEventListener("click", async () => {
      const content = postContent.value.trim();
      if (!content) return alert("내용을 입력하세요!");
      const author = localStorage.getItem("discordUser") || "익명";
      const discordId = localStorage.getItem("discordId") || "";
      await addDoc(collection(db, "posts"), {
        content,
        author,
        discordId,
        timestamp: serverTimestamp()
      });
      postContent.value = "";
      loadPosts();
    });

    searchInput.addEventListener("input", () => loadPosts(searchInput.value));
    clearSearch.addEventListener("click", () => {
      searchInput.value = "";
      loadPosts();
    });

    window.addEventListener("DOMContentLoaded", () => loadPosts());
  </script>
</body>
</html>

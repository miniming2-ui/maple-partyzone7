
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë©”ëœíŒŒí‹°ì¡´ - MapleLand Party Zone (v4)</title>
<meta name="description" content="ë©”ì´í”Œëœë“œ íŒŒí‹°ëª¨ì§‘ - ë©”ëœíŒŒí‹°ì¡´" />
<style>
  :root{--bg:#1A1A1D;--card:#242527;--muted:#BFC5CC;--accent:#5865F2;--accent-2:#3E86FF;--text:#EAEAEA;--glass:rgba(255,255,255,0.03);--radius:12px;}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, system-ui, -apple-system, 'Noto Sans KR', 'Malgun Gothic', sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-bottom:1px solid rgba(255,255,255,0.02)}
  .logo{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--accent);font-size:1.2rem}
  .logo .mark{font-size:20px}
  .right-controls{display:flex;align-items:center;gap:12px}
  .login-btn{background:var(--accent);border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;color:white}
  .logout-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
  .profile{display:flex;align-items:center;gap:10px}
  .avatar{width:40px;height:40px;border-radius:8px;background:#fff;overflow:hidden;display:inline-block;border:1px solid rgba(255,255,255,0.04)}
  main{max-width:1300px;margin:20px auto;padding:0 18px;display:grid;grid-template-columns:1fr 520px;gap:22px;align-items:start}
  .card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 8px 20px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
  .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:10px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-weight:700}
  .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;box-shadow:0 8px 18px rgba(88,101,242,0.12)}
  .panel-title{font-weight:800;margin:0 0 8px 0;color:var(--text)}
  .hint{color:var(--muted);font-size:13px;margin-bottom:10px}
  input, textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);margin-bottom:10px}
  .actions{display:flex;gap:8px;align-items:center}
  .primary{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:800}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
  .post{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border-radius:10px;padding:12px;margin-bottom:12px;border-left:4px solid rgba(255,255,255,0.02)}
  .post .title{font-weight:800;color:var(--text)}
  .meta{font-size:13px;color:var(--muted);margin-top:8px;display:flex;justify-content:space-between;align-items:center}
  .comment{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-top:6px;color:var(--text)}
  .chat-column{display:flex;flex-direction:column;height:calc(100vh - 160px)}
  .chat-list{overflow:auto;padding:8px;flex:1;display:flex;flex-direction:column;gap:10px}
  .chat-item{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;color:var(--text)}
  .small{font-size:13px;color:var(--muted)}
  .dm-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
  footer{text-align:center;padding:16px;color:var(--muted);font-size:13px;margin-top:18px}
  @media(max-width:1100px){main{grid-template-columns:1fr} .chat-column{height:auto}}
</style>
</head>
<body>
<header>
  <div class="logo"><span class="mark">ğŸ</span><span>ë©”ëœíŒŒí‹°ì¡´</span><span class="small">MapleLand Party Zone</span></div>
  <div class="right-controls">
    <div id="loggedArea" class="profile" style="display:none">
      <div class="avatar" id="userAvatar"><img id="avatarImg" src="" alt="avatar" style="width:100%;height:100%;object-fit:cover;display:block"></div>
      <div id="username" style="font-weight:700;color:var(--text)"></div>
      <button id="logoutBtn" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <button id="loginBtn" class="login-btn">Discordë¡œ ë¡œê·¸ì¸</button>
  </div>
</header>

<main>
  <section id="boardColumn">
    <div class="card">
      <div class="tabs" id="tabsContainer"></div>

      <div id="writeArea" style="margin-bottom:12px">
        <div class="panel-title">ëª¨ì§‘ê¸€ ì‘ì„±</div>
        <div class="hint">ë¡œê·¸ì¸ í•´ì•¼ ì‘ì„± ê°€ëŠ¥ (Discord ì—°ë™). ê²Œì‹œíŒ ì¿¨íƒ€ì„: <strong id="postCdLabel">10ë¶„</strong></div>
        <input id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
        <textarea id="postContent" rows="3" placeholder="ë‚´ìš© ë° ìš”êµ¬ì‚¬í•­"></textarea>
        <div class="actions">
          <button id="submitPost" class="primary">ëª¨ì§‘ ë“±ë¡</button>
          <button id="clearPost" class="ghost">ì´ˆê¸°í™”</button>
          <div id="postCooldown" class="small" style="margin-left:auto"></div>
        </div>
      </div>

      <div class="panel-title">ëª¨ì§‘ê¸€ ëª©ë¡</div>
      <div id="postsList" style="margin-top:10px"></div>
    </div>
  </section>

  <aside class="chat-column">
    <div class="card" style="display:flex;flex-direction:column;height:100%">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div>
          <div class="panel-title">ì‹¤ì‹œê°„ ì±„íŒ…</div>
          <div class="small">ì¿¨íƒ€ì„: <strong id="chatCdLabel">1ë¶„</strong></div>
        </div>
        <div class="small">ë¡œê·¸ì¸ í›„ ì±„íŒ… ê°€ëŠ¥</div>
      </div>

      <div id="chatList" class="chat-list"></div>

      <div style="margin-top:12px">
        <textarea id="chatInput" rows="3" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <button id="sendChat" class="primary">ì „ì†¡</button>
          <div id="chatCooldown" class="small" style="margin-left:8px"></div>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card small">
      <strong>ì„¤ì • ì•ˆë‚´</strong>
      <div style="margin-top:8px;color:var(--muted)">ì´ í˜ì´ì§€ëŠ” GitHub Pagesìš©ìœ¼ë¡œ ìë™ ë¡œê·¸ì¸ ì„¤ì •ì´ ë˜ì–´ ìˆìŠµë‹ˆë‹¤. Discord ê°œë°œì í¬í„¸ì— Redirect URIë¡œ <code>https://miniming2-ui.github.io/maple-partyzone/index.html</code> ë¥¼ ë“±ë¡í•˜ì„¸ìš”.</div>
    </div>
  </aside>
</main>

<footer>Â© 2025 ë©”ëœíŒŒí‹°ì¡´</footer>

<script>
/* ====== ì„¤ì • (GitHub Pages ì ìš©ëœ Redirect URI) ====== */
const DISCORD_CLIENT_ID = "1424448769113456752";
const REDIRECT_URI = "https://miniming2-ui.github.io/maple-partyzone/index.html";
const OAUTH_SCOPE = "identify";
/* ===================================================== */

// UI refs
const $ = id => document.getElementById(id);
const tabsContainer = document.getElementById('tabsContainer');
const postsList = $('postsList');
const chatList = $('chatList');
const postTitle = $('postTitle');
const postContent = $('postContent');
const chatInput = $('chatInput');
const submitPost = $('submitPost');
const sendChat = $('sendChat');
const loginBtn = $('loginBtn');
const logoutBtn = $('logoutBtn');
const loggedArea = $('loggedArea');
const usernameEl = $('username');
const avatarImg = $('avatarImg');
const postCooldownEl = $('postCooldown');
const chatCooldownEl = $('chatCooldown');
const postCdLabel = $('postCdLabel');
const chatCdLabel = $('chatCdLabel');

// Tabs: level tabs + special tabs
const TABS = [
  {id:'lvl_10_30', label:'10~30'}, {id:'lvl_30_50', label:'30~50'}, {id:'lvl_50_80', label:'50~80'},
  {id:'lvl_80_100', label:'80~100'}, {id:'lvl_100_130', label:'100~130'}, {id:'lvl_130_plus', label:'130 ì´ìƒ'},
  {id:'pq', label:'íŒŒí€˜ ëª¨ì§‘'}, {id:'boss', label:'ë³´ìŠ¤ ëª¨ì§‘'}, {id:'bloom', label:'ë¸”ë£¨ë¨¸ì‰¬ë§˜'}
];

let activeTab = TABS[0].id;
let currentUser = null;

// cooldowns (minutes)
const POST_COOLDOWN_MIN = 10;
const CHAT_COOLDOWN_MIN = 1;

// storage keys
const POSTS_KEY = 'mpz_v4_posts';
const CHATS_KEY = 'mpz_v4_chats';
const POST_CD_KEY = 'mpz_v4_post_cd';
const CHAT_CD_KEY = 'mpz_v4_chat_cd';
const USER_KEY = 'mpz_v4_user';

// util
function now(){return Date.now();}
function setCooldown(key, minutes){ localStorage.setItem(key, String(Date.now() + minutes*60*1000)); }
function getRemainingMs(key){ const v = parseInt(localStorage.getItem(key)||'0',10); const rem = v - Date.now(); return rem>0?rem:0; }
function formatMinutes(ms){ return (ms/60000).toFixed(1); }
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

postCdLabel.textContent = POST_COOLDOWN_MIN + 'ë¶„';
chatCdLabel.textContent = CHAT_COOLDOWN_MIN + 'ë¶„';

// create tabs UI
function initTabs(){
  TABS.forEach(t=>{
    const b = document.createElement('button'); b.className='tab'; b.textContent = t.label; b.dataset.id = t.id;
    if(t.id === activeTab) b.classList.add('active');
    b.addEventListener('click', ()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); activeTab = t.id; renderPosts(); });
    tabsContainer.appendChild(b);
  });
}

// storage helpers
function loadPosts(){ return JSON.parse(localStorage.getItem(POSTS_KEY) || '[]'); }
function savePosts(arr){ localStorage.setItem(POSTS_KEY, JSON.stringify(arr)); }
function loadChats(){ return JSON.parse(localStorage.getItem(CHATS_KEY) || '[]'); }
function saveChats(arr){ localStorage.setItem(CHATS_KEY, JSON.stringify(arr)); }
function saveUser(u){ localStorage.setItem(USER_KEY, JSON.stringify(u)); }
function loadUser(){ try{return JSON.parse(localStorage.getItem(USER_KEY)||'null')}catch(e){return null} }

// render posts for active tab
function renderPosts(){
  const all = loadPosts();
  postsList.innerHTML = '';
  const filtered = all.filter(p=>p.tab === activeTab);
  if(filtered.length === 0){ postsList.innerHTML = '<div class="small">í•´ë‹¹ íƒ­ì— ë“±ë¡ëœ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  filtered.forEach(p=>{
    const d = document.createElement('div'); d.className='post';
    const timeStr = new Date(p.ts).toLocaleString();
    d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
      <div style="flex:1">
        <div class="title">[${escapeHtml(p.tabLabel)}] ${escapeHtml(p.title)}</div>
        <div style="margin-top:8px">${escapeHtml(p.content)}</div>
        <div class="meta"><div>ì‘ì„±ì: <strong>${escapeHtml(p.author?.username || 'ìµëª…')}</strong></div><div>${timeStr}</div></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-left:8px">
        <button class="dm-btn" data-uid="${p.author?.id||''}">Discord DM</button>
        <button class="ghost comment-toggle" data-id="${p.id}">ëŒ“ê¸€</button>
      </div>
    </div>`;
    // comments area
    const cmArea = document.createElement('div'); cmArea.className='comment-area';
    (p.comments||[]).forEach(c=>{ const cm = document.createElement('div'); cm.className='comment'; cm.innerHTML = `<strong>${escapeHtml(c.author?.username||'ìµëª…')}</strong>: ${escapeHtml(c.text)} <div style="font-size:12px;color:var(--muted)">${new Date(c.ts).toLocaleString()}</div>`; cmArea.appendChild(cm); });
    const cf = document.createElement('div'); cf.style.display='none'; cf.style.marginTop='8px';
    cf.innerHTML = `<textarea rows="2" placeholder="ëŒ“ê¸€ ì…ë ¥..." style="width:100%;padding:8px;border-radius:8px;background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.04)"></textarea>
      <div style="display:flex;gap:8px;margin-top:6px"><button class="primary add-comment" data-id="${p.id}">ëŒ“ê¸€ ë“±ë¡</button></div>`;
    d.appendChild(cmArea); d.appendChild(cf); postsList.appendChild(d);

    // attach handlers
    d.querySelector('.dm-btn').addEventListener('click', ev=>{
      const uid = ev.currentTarget.dataset.uid; if(!uid){ alert('ì‘ì„±ì ì •ë³´ê°€ ì—†ì–´ DMìœ¼ë¡œ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      window.open('https://discord.com/users/' + uid, '_blank');
    });
    d.querySelector('.comment-toggle').addEventListener('click', ()=>{ cf.style.display = cf.style.display==='none' ? 'block' : 'none'; });
    d.querySelector('.add-comment').addEventListener('click', ev=>{
      if(!currentUser){ alert('ëŒ“ê¸€ì€ ë¡œê·¸ì¸ í›„ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
      const pid = ev.currentTarget.dataset.id; const ta = cf.querySelector('textarea'); const txt = ta.value.trim(); if(!txt) return alert('ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.');
      const posts = loadPosts(); const idx = posts.findIndex(x=>x.id===pid); if(idx===-1) return alert('ê²Œì‹œê¸€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      posts[idx].comments = posts[idx].comments || []; posts[idx].comments.push({ id:'c_'+Date.now(), author: currentUser, text: txt, ts: Date.now() }); savePosts(posts); renderPosts();
    });
  });
}

// render chats
function renderChats(){ const arr = loadChats(); chatList.innerHTML=''; if(arr.length===0){ chatList.innerHTML = '<div class="small">ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; } arr.forEach(c=>{ const el = document.createElement('div'); el.className='chat-item'; el.innerHTML = `<strong>${escapeHtml(c.author?.username||'ìµëª…')}</strong>: ${escapeHtml(c.text)}<div style="font-size:12px;color:var(--muted);margin-top:6px">${new Date(c.ts).toLocaleString()}</div>`; chatList.appendChild(el); }); }

// submit post
submitPost.addEventListener('click', ()=>{
  if(!currentUser) return alert('ê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
  const title = postTitle.value.trim(); const content = postContent.value.trim(); if(!title||!content) return alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
  if(getRemainingMs(POST_CD_KEY)>0) return alert('ê²Œì‹œê¸€ì€ ì¿¨íƒ€ì„ì´ ì ìš©ë©ë‹ˆë‹¤.');
  const posts = loadPosts(); const label = TABS.find(t=>t.id===activeTab).label || activeTab;
  const p = { id:'p_'+Date.now(), tab: activeTab, tabLabel: label, title, content, author: currentUser, ts: Date.now(), comments: [] }; posts.unshift(p); savePosts(posts);
  setCooldown(POST_CD_KEY, POST_COOLDOWN_MIN); postTitle.value=''; postContent.value=''; renderPosts();
});

// send chat
sendChat.addEventListener('click', ()=>{
  if(!currentUser) return alert('ì±„íŒ…ì€ ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
  const txt = chatInput.value.trim(); if(!txt) return alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  if(getRemainingMs(CHAT_CD_KEY)>0) return alert('ì±„íŒ…ì€ ì¿¨íƒ€ì„ì´ ì ìš©ë©ë‹ˆë‹¤.');
  const arr = loadChats(); arr.unshift({ id:'ch_'+Date.now(), author: currentUser, text: txt, ts: Date.now() }); saveChats(arr); setCooldown(CHAT_CD_KEY, CHAT_COOLDOWN_MIN); chatInput.value=''; renderChats();
});

// cooldown UI
function updateCooldownUI(){ const rp = getRemainingMs(POST_CD_KEY); const rc = getRemainingMs(CHAT_CD_KEY); postCooldownEl.textContent = rp>0 ? `ë“±ë¡ ì¿¨íƒ€ì„: ${formatMinutes(rp)}ë¶„ ë‚¨ìŒ` : ''; chatCooldownEl.textContent = rc>0 ? `ì±„íŒ… ì¿¨íƒ€ì„: ${formatMinutes(rc)}ë¶„ ë‚¨ìŒ` : ''; submitPost.disabled = rp>0; sendChat.disabled = rc>0; }
setInterval(updateCooldownUI, 1000);

// OAuth helpers (implicit)
function buildAuthUrl(){ const base = 'https://discord.com/oauth2/authorize'; const params = new URLSearchParams({ client_id: DISCORD_CLIENT_ID, redirect_uri: REDIRECT_URI, response_type: 'token', scope: OAUTH_SCOPE }); return base + '?' + params.toString(); }
function handleAuthFromHash(){ const hash = location.hash.substring(1); if(!hash) return; const params = new URLSearchParams(hash); const token = params.get('access_token'); if(token){ sessionStorage.setItem('discord_access_token', token); history.replaceState(null,'',REDIRECT_URI); fetchDiscordUser(token).then(u=>{ if(u) setUser(u, token); else alert('Discord ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (CORS ë˜ëŠ” í”„ë¡ì‹œ í•„ìš”í•  ìˆ˜ ìˆìŒ)'); }); } }
async function fetchDiscordUser(token){ try{ const res = await fetch('https://discord.com/api/users/@me',{ headers: { Authorization: 'Bearer '+token } }); if(!res.ok){ console.warn('Discord API error',res.status); return null;} return await res.json(); }catch(e){ console.error(e); return null; } }
function setUser(userObj, token){ currentUser = { id: userObj.id, username: userObj.username + (userObj.discriminator?('#'+userObj.discriminator):''), avatar: userObj.avatar?('https://cdn.discordapp.com/avatars/'+userObj.id+'/'+userObj.avatar+'.png'):'' }; saveUser(currentUser); sessionStorage.setItem('mpz_token', token||''); renderUser(); }
loginBtn.addEventListener('click', ()=>{ const url = buildAuthUrl(); console.log('Redirecting to', url); location.href = url; });
logoutBtn.addEventListener('click', ()=>{ sessionStorage.removeItem('discord_access_token'); sessionStorage.removeItem('mpz_token'); localStorage.removeItem(USER_KEY); currentUser = null; renderUser(); });

function renderUser(){ const u = loadUser(); if(u) currentUser = u; if(currentUser){ loginBtn.style.display='none'; loggedArea.style.display='flex'; usernameEl.textContent = currentUser.username; if(currentUser.avatar) avatarImg.src = currentUser.avatar; } else { loginBtn.style.display='inline-block'; loggedArea.style.display='none'; } }

// initial seed & boot
(function init(){ initTabs(); // sample data if empty
  if(loadPosts().length===0){ const sample=[
    {id:'p_s1',tab:'lvl_10_30',tabLabel:'10~30',title:'ì´ˆë³´ í™˜ì˜ íŒŒí€˜',content:'íŒŒí€˜ ê°™ì´ ëŒ ë¶„ ëª¨ì§‘í•©ë‹ˆë‹¤',author:{username:'ìƒ˜í”Œ#0001'},ts:Date.now()-3600000,comments:[]},
    {id:'p_s2',tab:'lvl_30_50',tabLabel:'30~50',title:'ë³´ìŠ¤ ëŸ¬ë‹',content:'ê°„ë‹¨í•œ ë³´ìŠ¤ íŒŒí‹°',author:{username:'ë”œëŸ¬#1001'},ts:Date.now()-7200000,comments:[]},
    {id:'p_s3',tab:'pq',tabLabel:'íŒŒí€˜ ëª¨ì§‘',title:'íŒŒí€˜ í’€ íŒŒí‹° ëª¨ì§‘',content:'ê²½í—˜ì ìš°ëŒ€',author:{username:'í•˜ì´ë ˆë²¨#777'},ts:Date.now()-10800000,comments:[]}
  ]; savePosts(sample); }
  renderUser(); handleAuthFromHash(); renderPosts(); renderChats(); })();
</script>
</body>
</html>

<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë©”ëœíŒŒí‹°ì¡´ | Maple Party Zone</title>
  <meta name="description" content="ë©”ì´í”Œëœë“œ íŒŒí‹°ëª¨ì§‘ - ë©”ëœíŒŒí‹°ì¡´" />
  <meta name="robots" content="index,follow" />
  <style>
    :root{--bg:#0f1113;--card:#17181a;--muted:#bfc5cc;--accent:#5865F2;--text:#EAEAEA;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, 'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-bottom:1px solid rgba(255,255,255,0.02)}
    .logo{font-weight:800;color:var(--accent);font-size:1.2rem}
    #loginArea button{background:var(--accent);border:none;padding:8px 12px;border-radius:10px;cursor:pointer;color:white}
    .worlds{display:flex;gap:12px;overflow:auto;padding:12px;background:#131313}
    .world{flex:0 0 160px;height:90px;border-radius:10px;background-size:cover;background-position:center;position:relative;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
    .world .label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;color:white;text-shadow:0 2px 6px rgba(0,0,0,0.6)}
    .container{max-width:1200px;margin:20px auto;padding:0 18px}
    .main-grid{display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start}
    .card{background:var(--card);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:8px;background:transparent;color:var(--muted);cursor:pointer;font-weight:700}
    .tab.active{background:linear-gradient(90deg,var(--accent),#3e86ff);color:white}
    input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#161616;color:var(--text)}
    button.primary{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .post{margin-bottom:12px;padding:12px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
    .small{font-size:13px;color:var(--muted)}
    .hidden{display:none !important}
    @media(max-width:980px){.main-grid{grid-template-columns:1fr} .world{flex:0 0 140px}}
  </style>
</head>
<body>
  <header>
    <div class="logo">ğŸ ë©”ëœíŒŒí‹°ì¡´</div>
    <div id="loginArea">
      <button id="loginBtn">ë””ìŠ¤ì½”ë“œ ë¡œê·¸ì¸</button>
    </div>
  </header>

  <!-- World bar -->
  <div class="worlds" id="worldBar">
    <!-- images loaded via JS / or keep matching filenames in /images -->
    <div class="world" data-id="victoria" style="background-image:url('./images/victoria.png')"><div class="label">ë¹…í† ë¦¬ì•„</div></div>
    <div class="world" data-id="elnath" style="background-image:url('./images/elnath.png')"><div class="label">ì—˜ë‚˜ìŠ¤</div></div>
    <div class="world" data-id="luduslake" style="background-image:url('./images/luduslake.png')"><div class="label">ë£¨ë”ìŠ¤ í˜¸ìˆ˜</div></div>
    <div class="world" data-id="minar" style="background-image:url('./images/minar.png')"><div class="label">ë¯¸ë‚˜ë¥´ ìˆ²</div></div>
    <div class="world" data-id="aqua" style="background-image:url('./images/aqua.png')"><div class="label">ì•„ì¿ ì•„ ë¡œë“œ</div></div>
    <div class="world" data-id="nihal" style="background-image:url('./images/nihal.png')"><div class="label">ë‹ˆí•  ì‚¬ë§‰</div></div>
  </div>

  <div class="container">
    <div id="mainView">
      <div class="main-grid">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800;font-size:18px">ë©”ì¸ - ì „ì²´ ëª¨ì§‘</div>
              <div class="small">ë ˆë²¨ëŒ€ë³„ íƒ­ì€ ë©”ì¸ì—ì„œë§Œ í‘œì‹œë©ë‹ˆë‹¤</div>
            </div>
            <div class="small">ê²Œì‹œê¸€ ì¿¨íƒ€ì„: 3ë¶„ Â· ì±„íŒ… ì¿¨íƒ€ì„: 1ë¶„</div>
          </div>

          <div id="levelTabs" class="tabs" style="margin-top:12px"></div>

          <div id="writeArea" style="margin-top:10px">
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <input id="postSearch" placeholder="ê²€ìƒ‰ (ì œëª©/ë‚´ìš©/ì‘ì„±ì)"/>
              <button id="clearSearch" class="tab">ì´ˆê¸°í™”</button>
            </div>
            <input id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
            <textarea id="postContent" rows="3" placeholder="ëª¨ì§‘ ë‚´ìš©"></textarea>
            <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
              <button id="submitPost" class="primary">ëª¨ì§‘ ë“±ë¡</button>
              <div id="postCooldown" class="small" style="margin-left:auto"></div>
            </div>
          </div>

          <div style="margin-top:12px" id="postsList"></div>
        </div>

        <aside class="card" style="width:100%;display:flex;flex-direction:column">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div><div style="font-weight:800">ì‹¤ì‹œê°„ ì±„íŒ…</div><div class="small">ì¿¨íƒ€ì„: <strong>1ë¶„</strong></div></div>
            <div class="small">ë¡œê·¸ì¸ í›„ ì±„íŒ… ê°€ëŠ¥</div>
          </div>

          <div id="chatList" style="flex:1;overflow:auto;padding:8px;background:#0f1113;border-radius:8px;margin-bottom:8px"></div>

          <textarea id="chatInput" rows="3" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <button id="sendChat" class="primary">ì „ì†¡</button>
            <div id="chatCooldown" class="small"></div>
          </div>
        </aside>
      </div>
    </div>

    <!-- region view -->
    <div id="regionView" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <div id="regionTitle" style="font-weight:800;font-size:18px">ì§€ì—­ ëª¨ì§‘</div>
          <div class="small">ì„ íƒí•œ ëŒ€ë¥™ì˜ ëª¨ì§‘ê¸€ë§Œ í‘œì‹œë©ë‹ˆë‹¤</div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="backBtn" class="tab">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
      </div>

      <div class="main-grid">
        <div class="card">
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="regionSearch" placeholder="ê²€ìƒ‰ (ì œëª©/ë‚´ìš©/ì‘ì„±ì)"/>
            <button id="clearRegionSearch" class="tab">ì´ˆê¸°í™”</button>
          </div>

          <div id="regionWrite" style="margin-top:8px">
            <input id="regionPostTitle" placeholder="ì œëª©" />
            <textarea id="regionPostContent" rows="3" placeholder="ë‚´ìš©"></textarea>
            <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
              <button id="regionSubmit" class="primary">ëª¨ì§‘ ë“±ë¡</button>
              <div id="regionPostCooldown" class="small" style="margin-left:auto"></div>
            </div>
          </div>

          <div id="regionPosts"></div>
        </div>

        <aside class="card" style="width:100%;display:flex;flex-direction:column">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div><div style="font-weight:800">ì‹¤ì‹œê°„ ì±„íŒ… (ì§€ì—­)</div><div class="small">ì„ íƒëœ ì§€ì—­ì˜ ì±„íŒ…</div></div>
            <div class="small">ë¡œê·¸ì¸ í›„ ì±„íŒ… ê°€ëŠ¥</div>
          </div>

          <div id="regionChatList" style="flex:1;overflow:auto;padding:8px;background:#0f1113;border-radius:8px;margin-bottom:8px"></div>

          <textarea id="regionChatInput" rows="3" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <button id="regionSendChat" class="primary">ì „ì†¡</button>
            <div id="regionChatCooldown" class="small"></div>
          </div>
        </aside>
      </div>
    </div>

  </div>

  <!-- Firebase JS SDKs (modular) -->
  <script type="module">
  // Firebase ëª¨ë“ˆ import (CDN)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // ---------- ì‚¬ìš©ìê°€ ì œê³µí•œ firebaseConfig (ì´ë¯¸ ì œê³µëœ ê°’) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyB059CBnkyxlsJZbMfbBK5AJ_s4XKbYGcI",
    authDomain: "maple-partyzone.firebaseapp.com",
    projectId: "maple-partyzone",
    storageBucket: "maple-partyzone.firebasestorage.app",
    messagingSenderId: "853981783847",
    appId: "1:853981783847:web:2305406459583a8f072b02",
    measurementId: "G-CNGYW8FF27"
  };
  // --------------------------------------------------------------------

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /* ===== app config ===== */
  const CLIENT_ID = "1424448769113456752";
  const REDIRECT_URI = "https://miniming2-ui.github.io/maple-partyzone7/";
  const OAUTH_SCOPE = "identify";

  const LEVEL_TABS = ['10~30','30~50','50~80','80~100','100~130','130 ì´ìƒ'];
  const REGIONS = ['victoria','elnath','luduslake','minar','aqua','nihal'];

  /* ===== UI refs ===== */
  const worldEls = document.querySelectorAll('.world');
  const levelTabsEl = document.getElementById('levelTabs');
  const postsList = document.getElementById('postsList');
  const postTitle = document.getElementById('postTitle');
  const postContent = document.getElementById('postContent');
  const postSearch = document.getElementById('postSearch');
  const clearSearch = document.getElementById('clearSearch');
  const submitPost = document.getElementById('submitPost');
  const postCooldownEl = document.getElementById('postCooldown');

  const chatList = document.getElementById('chatList');
  const chatInput = document.getElementById('chatInput');
  const sendChat = document.getElementById('sendChat');
  const chatCooldownEl = document.getElementById('chatCooldown');

  const mainView = document.getElementById('mainView');
  const regionView = document.getElementById('regionView');
  const regionTitle = document.getElementById('regionTitle');
  const backBtn = document.getElementById('backBtn');

  const regionSearch = document.getElementById('regionSearch');
  const regionPosts = document.getElementById('regionPosts');
  const regionPostTitle = document.getElementById('regionPostTitle');
  const regionPostContent = document.getElementById('regionPostContent');
  const regionSubmit = document.getElementById('regionSubmit');
  const regionChatList = document.getElementById('regionChatList');
  const regionChatInput = document.getElementById('regionChatInput');
  const regionSendChat = document.getElementById('regionSendChat');
  const regionPostCooldown = document.getElementById('regionPostCooldown');
  const regionChatCooldown = document.getElementById('regionChatCooldown');

  const loginBtn = document.getElementById('loginBtn');
  const loginArea = document.getElementById('loginArea');

  /* ===== cooldowns (minutes) ===== */
  const POST_CD_MIN = 3;
  const CHAT_CD_MIN = 1;

  /* storage keys */
  const POSTS_COLL = 'posts';
  const USER_KEY = 'mpz_final_user';
  const POST_CD_KEY = 'mpz_final_post_cd';
  const CHAT_CD_KEY = 'mpz_final_chat_cd';

  /* ===== helpers ===== */
  function now(){return Date.now();}
  function setCooldown(key, minutes){ localStorage.setItem(key, String(Date.now()+minutes*60*1000)); }
  function getRemainingMs(key){ const v = parseInt(localStorage.getItem(key)||'0',10); const rem = v - Date.now(); return rem>0?rem:0; }
  function formatMinutes(ms){ return (ms/60000).toFixed(1); }
  function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  function saveUser(u){ localStorage.setItem(USER_KEY, JSON.stringify(u)); }
  function loadUser(){ try{return JSON.parse(localStorage.getItem(USER_KEY)||'null')}catch(e){return null} }

  /* ===== level tabs ===== */
  function initLevelTabs(){
    levelTabsEl.innerHTML = '';
    LEVEL_TABS.forEach(l=>{
      const b = document.createElement('button'); b.className='tab'+(l===LEVEL_TABS[0]?' active':''); b.textContent = l;
      b.addEventListener('click', ()=>{ document.querySelectorAll('#levelTabs .tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderPosts(); });
      levelTabsEl.appendChild(b);
    });
  }

  /* ===== Dash: Firestore realtime listeners ===== */
  // listen all posts (we'll filter in render)
  const postsRef = collection(db, POSTS_COLL);
  // order by createdAt desc (serverTimestamp)
  const qAll = query(postsRef, orderBy('createdAt','desc'));

  let cachedPosts = [];

  onSnapshot(qAll, snapshot => {
    cachedPosts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    // render currently visible views
    if(document.getElementById('mainView').classList.contains('hidden')){
      renderRegionPosts();
      renderRegionChats();
    } else {
      renderPosts();
      renderChats();
    }
  }, err => {
    console.error('Firestore snapshot error', err);
  });

  /* ===== render main posts (filter by level) ===== */
  function renderPosts(){
    const search = (postSearch.value||'').trim().toLowerCase();
    const levelActive = document.querySelector('#levelTabs .tab.active')?.textContent || LEVEL_TABS[0];
    const filtered = cachedPosts.filter(p => p.type === 'board' && !p.region && p.level === levelActive)
      .filter(p => {
        if(!search) return true;
        const hay = (p.title + ' ' + p.content + ' ' + (p.authorName||'')).toLowerCase();
        return hay.indexOf(search)!==-1;
      });
    postsList.innerHTML = '';
    if(filtered.length===0){ postsList.innerHTML = '<div class="small">í•´ë‹¹ ë ˆë²¨ëŒ€ì— ë“±ë¡ëœ ëª¨ì§‘ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    filtered.forEach(p=>{
      const d = document.createElement('div'); d.className='post';
      d.innerHTML = `<div style="font-weight:800">${escapeHtml(p.title)}</div><div style="margin-top:6px">${escapeHtml(p.content)}</div><div class="small" style="margin-top:8px">${escapeHtml(p.authorName||'ìµëª…')} Â· ${new Date(p.createdAt?.toDate ? p.createdAt.toDate() : p.createdAt).toLocaleString()}</div>`;
      postsList.appendChild(d);
    });
  }

  /* ===== render region posts ===== */
  let activeRegion = null;
  function renderRegionPosts(){
    regionPosts.innerHTML = '';
    if(!activeRegion) return;
    const search = (regionSearch.value||'').trim().toLowerCase();
    const filtered = cachedPosts.filter(p => p.type === 'board' && p.region === activeRegion)
      .filter(p => {
        if(!search) return true;
        const hay = (p.title + ' ' + p.content + ' ' + (p.authorName||'')).toLowerCase();
        return hay.indexOf(search)!==-1;
      });
    if(filtered.length===0){ regionPosts.innerHTML = '<div class="small">í•´ë‹¹ ì§€ì—­ì— ë“±ë¡ëœ ëª¨ì§‘ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    filtered.forEach(p=>{
      const d = document.createElement('div'); d.className='post';
      d.innerHTML = `<div style="font-weight:800">${escapeHtml(p.title)}</div><div style="margin-top:6px">${escapeHtml(p.content)}</div><div class="small" style="margin-top:8px">${escapeHtml(p.authorName||'ìµëª…')} Â· ${new Date(p.createdAt?.toDate ? p.createdAt.toDate() : p.createdAt).toLocaleString()}</div>`;
      regionPosts.appendChild(d);
    });
  }

  /* ===== render chats (main) ===== */
  function renderChats(){
    chatList.innerHTML = '';
    const levelActive = document.querySelector('#levelTabs .tab.active')?.textContent || LEVEL_TABS[0];
    const arr = cachedPosts.filter(c => c.type === 'chat' && !c.region && c.level === levelActive);
    if(arr.length===0){ chatList.innerHTML = '<div class="small">ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    arr.forEach(c => {
      const el = document.createElement('div'); el.className='post';
      el.innerHTML = `<strong>${escapeHtml(c.authorName||'ìµëª…')}</strong>: ${escapeHtml(c.content)}<div class="small" style="margin-top:6px">${new Date(c.createdAt?.toDate ? c.createdAt.toDate() : c.createdAt).toLocaleString()}</div>`;
      chatList.appendChild(el);
    });
  }

  function renderRegionChats(){
    regionChatList.innerHTML = '';
    const arr = cachedPosts.filter(c => c.type === 'chat' && c.region === activeRegion);
    if(arr.length===0){ regionChatList.innerHTML = '<div class="small">ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    arr.forEach(c => {
      const el = document.createElement('div'); el.className='post';
      el.innerHTML = `<strong>${escapeHtml(c.authorName||'ìµëª…')}</strong>: ${escapeHtml(c.content)}<div class="small" style="margin-top:6px">${new Date(c.createdAt?.toDate ? c.createdAt.toDate() : c.createdAt).toLocaleString()}</div>`;
      regionChatList.appendChild(el);
    });
  }

  /* ===== create document in posts collection (shared for board+chat) ===== */
  async function createPostDoc(docObj){
    try{
      await addDoc(postsRef, docObj);
    }catch(e){
      console.error('addDoc error', e);
      alert('ì„œë²„ì— ê¸€ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  /* ===== submit main post (board) ===== */
  document.getElementById('submitPost').addEventListener('click', async ()=>{
    const user = loadUser();
    if(!user) return alert('ê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    if(getRemainingMs(POST_CD_KEY)>0) return alert('ê²Œì‹œê¸€ ì¿¨íƒ€ì„ì´ ì ìš©ì¤‘ì…ë‹ˆë‹¤.');
    const title = postTitle.value.trim(), content = postContent.value.trim();
    if(!title || !content) return alert('ì œëª©/ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
    const levelActive = document.querySelector('#levelTabs .tab.active')?.textContent || LEVEL_TABS[0];
    await createPostDoc({ type:'board', title, content, authorId:user.id||null, authorName:user.username||'ìµëª…', level:levelActive, region:null, createdAt: serverTimestamp() });
    setCooldown(POST_CD_KEY, POST_CD_MIN);
    postTitle.value=''; postContent.value='';
  });

  /* ===== submit region post ===== */
  regionSubmit.addEventListener('click', async ()=>{
    const user = loadUser();
    if(!user) return alert('ê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    if(getRemainingMs(POST_CD_KEY)>0) return alert('ê²Œì‹œê¸€ ì¿¨íƒ€ì„ì´ ì ìš©ì¤‘ì…ë‹ˆë‹¤.');
    const title = regionPostTitle.value.trim(), content = regionPostContent.value.trim();
    if(!title || !content) return alert('ì œëª©/ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
    await createPostDoc({ type:'board', title, content, authorId:user.id||null, authorName:user.username||'ìµëª…', level:null, region:activeRegion, createdAt: serverTimestamp() });
    setCooldown(POST_CD_KEY, POST_CD_MIN);
    regionPostTitle.value=''; regionPostContent.value='';
  });

  /* ===== chat send (main) ===== */
  sendChat.addEventListener('click', async ()=>{
    const user = loadUser();
    if(!user) return alert('ì±„íŒ…ì€ ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    if(getRemainingMs(CHAT_CD_KEY)>0) return alert('ì±„íŒ… ì¿¨íƒ€ì„ì´ ì ìš©ì¤‘ì…ë‹ˆë‹¤.');
    const txt = chatInput.value.trim(); if(!txt) return;
    await createPostDoc({ type:'chat', content:txt, authorId:user.id||null, authorName:user.username||'ìµëª…', level: document.querySelector('#levelTabs .tab.active')?.textContent || LEVEL_TABS[0], region:null, createdAt: serverTimestamp() });
    setCooldown(CHAT_CD_KEY, CHAT_CD_MIN); chatInput.value=''; 
  });

  /* ===== chat send (region) ===== */
  regionSendChat.addEventListener('click', async ()=>{
    const user = loadUser();
    if(!user) return alert('ì±„íŒ…ì€ ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    if(getRemainingMs(CHAT_CD_KEY)>0) return alert('ì±„íŒ… ì¿¨íƒ€ì„ì´ ì ìš©ì¤‘ì…ë‹ˆë‹¤.');
    const txt = regionChatInput.value.trim(); if(!txt) return;
    await createPostDoc({ type:'chat', content:txt, authorId:user.id||null, authorName:user.username||'ìµëª…', level:null, region:activeRegion, createdAt: serverTimestamp() });
    setCooldown(CHAT_CD_KEY, CHAT_CD_MIN); regionChatInput.value='';
  });

  /* ===== cooldown UI updater ===== */
  function updateCooldownUI(){ const rp=getRemainingMs(POST_CD_KEY); const rc=getRemainingMs(CHAT_CD_KEY);
    postCooldownEl.textContent = rp>0?`ê²Œì‹œê¸€ ì¿¨íƒ€ì„: ${formatMinutes(rp)}ë¶„ ë‚¨ìŒ` : '';
    chatCooldownEl.textContent = rc>0?`ì±„íŒ… ì¿¨íƒ€ì„: ${formatMinutes(rc)}ë¶„ ë‚¨ìŒ` : '';
    submitPost.disabled = rp>0; sendChat.disabled = rc>0; regionSubmit.disabled = rp>0; regionSendChat.disabled = rc>0;
  }
  setInterval(updateCooldownUI,1000);

  /* ===== search handlers ===== */
  postSearch.addEventListener('input', renderPosts);
  clearSearch.addEventListener('click', ()=>{ postSearch.value=''; renderPosts(); });
  regionSearch.addEventListener('input', renderRegionPosts);
  document.getElementById('clearRegionSearch').addEventListener('click', ()=>{ regionSearch.value=''; renderRegionPosts(); });

  /* ===== region selection & history management ===== */
  worldEls.forEach(w=> w.addEventListener('click', (e)=> {
    const id = w.dataset.id; activeRegion = id;
    document.getElementById('regionTitle').textContent = w.querySelector('.label').textContent + ' ëª¨ì§‘';
    mainView.classList.add('hidden'); regionView.classList.remove('hidden');
    renderRegionPosts(); renderRegionChats();
    // push state so back button works
    history.pushState({ region: activeRegion }, '', '#'+encodeURIComponent(activeRegion));
  }));

  backBtn.addEventListener('click', ()=>{
    history.back();
  });

  window.addEventListener('popstate', (event)=>{
    if(event.state && event.state.region){
      activeRegion = event.state.region;
      mainView.classList.add('hidden'); regionView.classList.remove('hidden');
      renderRegionPosts(); renderRegionChats();
    } else {
      // go main
      activeRegion = null;
      mainView.classList.remove('hidden'); regionView.classList.add('hidden');
      renderPosts(); renderChats();
    }
  });

  // on load: if url has hash, open region
  window.addEventListener('load', ()=>{
    const hash = decodeURIComponent(location.hash.replace('#','')) || '';
    if(hash && REGIONS.includes(hash)){
      // simulate click
      activeRegion = hash;
      document.getElementById('regionTitle').textContent = document.querySelector(`[data-id="${hash}"] .label`).textContent + ' ëª¨ì§‘';
      mainView.classList.add('hidden'); regionView.classList.remove('hidden');
      renderRegionPosts(); renderRegionChats();
      history.replaceState({ region: activeRegion }, '', '#'+encodeURIComponent(activeRegion));
    }
    initLevelTabs();
    handleDiscordLogin();
  });

  /* ===== Discord login flow (implicit grant) ===== */
  loginBtn.addEventListener('click', ()=> {
    const url = `https://discord.com/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${OAUTH_SCOPE}`;
    window.location.href = url;
  });

  function handleDiscordLogin(){
    const hash = window.location.hash;
    if(hash && hash.includes('access_token')){
      try{
        const params = new URLSearchParams(hash.replace('#',''));
        const token = params.get('access_token');
        // fetch user
        fetch('https://discord.com/api/users/@me', { headers: { Authorization: `Bearer ${token}` } })
        .then(r => {
          if(!r.ok) throw new Error('discord fetch failed');
          return r.json();
        })
        .then(user => {
          const u = { id: user.id, username: user.username + (user.discriminator?('#'+user.discriminator):'') , avatar: user.avatar?`https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`:'' };
          saveUser(u);
          loginArea.innerHTML = `ğŸ‘¤ ${u.username}`;
          // remove hash and reset URL to redirect URI
          history.replaceState(null,'',REDIRECT_URI);
        })
        .catch(err => {
          console.error(err);
          alert('ë””ìŠ¤ì½”ë“œ ë¡œê·¸ì¸ ì‹¤íŒ¨: ì„¤ì •(redirect URI/implicit) í™•ì¸ í•„ìš”');
        });
      }catch(e){
        console.error(e);
      }
    } else {
      const u = loadUser();
      if(u){ loginArea.innerHTML = `ğŸ‘¤ ${u.username}`; }
    }
  }

  </script>
</body>
</html>
